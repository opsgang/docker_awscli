# vim: et sr sw=2 ts=2 smartindent:
language: none

branches:
  only:
    - evaluate_shippable

env:
  - secure: 3yF/Z8TLKOYeNjdHNqArN5mBrlSRPewBgkQ9ksgucMUgyiOUuWJQgPn7+szasLtA9fqOXhpi2i/CTS/7Tb8bGwmK+pXnciyJ8fmOxXN8UrqVft1eXrYwqxKLt1aU8BC+0MXvz59xJ78eNsgkjwW5ajdibr4yMU42iXsMD4NC8/7UaD31fUG3FqZOTYOPLIo+e3BuDExjjtmLgbB8RMIIewZTNB/z8tN8oIUSL3n8vpe2pdg1T66J3rhcol4gWLUOsZoWl+JrASXYqzci00RXEy4P7w073soZ3eM++Em4PyImxtRd0Xr68w9+b5tG6UPOWdEYujhF3HLAs2+2LrQg3A==

reset_minion: true

build:

  ci:
    - docker pull opsgang/awscli:stable # speed up build layers
    - git clone https://github.com/opsgang/alpine_build_scripts --depth 1 && ls -1a
    - shippable_retry bash ./build.sh # avoid aufs file-locking issues by running new shell

  on_success:
    - sudo apt-get update && sudo apt-get -y install jq
    - docker inspect opsgang/awscli:candidate | jq -r '.[].Config.Labels.version' >.v
    - docker inspect opsgang/awscli:candidate | jq -r '.[].Config.Labels.awscli_version' >.av
    - docker tag opsgang/awscli:candidate opsgang/awscli:$(cat .v)
    - docker tag opsgang/awscli:candidate opsgang/awscli:$(cat .av)
    - echo "version tag is " $(cat .v)
    - docker login -p $DHP -u $DHU
    - docker push opsgang/awscli:$(cat .v)
    - docker push opsgang/awscli:$(cat .av)
